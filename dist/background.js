const w={xmlhttprequest:"xhr",stylesheet:"css",script:"script",image:"img",font:"font",media:"media",websocket:"media",main_frame:"doc",sub_frame:"doc",object:"other",ping:"other",csp_report:"other",other:"other"};function v(r,n){return n.some(e=>{if(e.startsWith("/")&&e.lastIndexOf("/")>0){const t=e.lastIndexOf("/");try{return new RegExp(e.slice(1,t),e.slice(t+1)).test(r)}catch{return r.includes(e)}}return r.includes(e)})}function G(){return{sniffing:!1,requests:[],targetTabId:null,recording:!1,recordTabId:null,recordSourceUrl:null,recordEntries:[],recordTargetId:null,recordFilters:["xhr","fetch"],ignorePatterns:[],activeReplays:{},replayHitCount:0,recordings:[],originGroups:[]}}function V(r){const n=!r.sniffing;return{...r,sniffing:n,requests:n?[]:r.requests,targetTabId:n?r.targetTabId:null}}function S(r){return{...r,requests:[]}}function q(r,n){return{...r,recordFilters:n}}function C(r,n){return!n||r.ignorePatterns.includes(n)?r:{...r,ignorePatterns:[...r.ignorePatterns,n]}}function F(r,n){return{...r,ignorePatterns:r.ignorePatterns.filter(e=>e!==n)}}function O(r,n){return{...r,originGroups:Array.isArray(n)?n:[]}}function A(r,n,e){const t=r.recordings.map(o=>o.id!==n?o:{...o,originGroupIds:Array.isArray(e)?e:[]});return{...r,recordings:t}}function U(r,n){const e=r.recordings.find(t=>t.id===n);return!e||!e.originGroupIds||e.originGroupIds.length===0?[]:r.originGroups.filter(t=>e.originGroupIds.includes(t.id)).flatMap(t=>t.mappings||[])}function D(r,n,e){return{...r,recording:!0,recordEntries:[],recordTargetId:e||null,recordFilters:n||r.recordFilters}}function k(r,n){const e=Date.now().toString(),t={id:e,name:`Recording ${r.recordings.length+1}`,timestamp:Date.now(),sourceUrl:null,ignorePatterns:[...r.ignorePatterns],entries:[]};return{...r,recording:!0,recordEntries:[],recordTargetId:e,recordFilters:n||r.recordFilters,recordings:[...r.recordings,t]}}function M(r){const n={...r,recording:!1,recordTabId:null,recordTargetId:null};if(r.recordEntries.length>0){const e={id:Date.now().toString(),name:`Recording ${r.recordings.length+1}`,timestamp:Date.now(),sourceUrl:r.recordSourceUrl,ignorePatterns:[...r.ignorePatterns],entries:r.recordEntries};n.recordings=[...r.recordings,e]}return n.recordEntries=[],n}function _(r,n){const e={...r,recording:!1,recordTabId:null,recordTargetId:null};let t=r.recordings;r.recordEntries.length>0&&(t=t.map(c=>c.id!==n?c:{...c,entries:[...c.entries,...r.recordEntries]}));const o=t.find(c=>c.id===n);return o&&o.entries.length===0&&(t=t.filter(c=>c.id!==n)),e.recordings=t,e.recordEntries=[],e}function j(r,n){return!r.recording||!n||v(n.url,r.ignorePatterns)||!r.recordFilters.includes(n.kind)?r:{...r,recordEntries:[...r.recordEntries,n]}}function H(r,n){const e={...r.activeReplays};delete e[n];const t=Object.keys(e).length>0;return{...r,activeReplays:e,replayHitCount:t?r.replayHitCount:0}}function W(r,n){const e={...r.activeReplays};return delete e[n],{...r,activeReplays:e,recordings:r.recordings.filter(t=>t.id!==n)}}function B(r,n,e){if(!Array.isArray(e))return r;const t=r.recordings.map(o=>o.id!==n?o:{...o,entries:[...o.entries,...e]});return{...r,recordings:t}}function L(r,n,e){const t=r.recordings.find(d=>d.id===n),o=r.recordings.find(d=>d.id===e);if(!t||!o)return r;const c=r.recordings.map(d=>d.id===e?{...d,entries:[...d.entries,...t.entries]}:d).filter(d=>d.id!==n);return{...r,recordings:c}}function $(r,n,e){const t=r.recordings.map(o=>o.id!==n?o:{...o,name:e});return{...r,recordings:t}}function x(r,n,e){const t=r.recordings.map(o=>o.id!==n?o:{...o,...e});return{...r,recordings:t}}function K(r,n,e,t){const o=r.recordings.map(c=>{if(c.id!==n||e<0||e>=c.entries.length)return c;const d=[...c.entries];return d[e]={...d[e],...t},{...c,entries:d}});return{...r,recordings:o}}function N(r,n){const e=new Set,t=r.recordings.map(c=>{if(c.id!==n)return c;const d=c.entries.filter(a=>e.has(a.url)?!1:(e.add(a.url),!0));return{...c,entries:d}});let o=r.recordEntries;return r.recording&&r.recordTargetId===n&&(o=o.filter(c=>e.has(c.url)?!1:(e.add(c.url),!0))),{...r,recordings:t,recordEntries:o}}function Y(r,n,e){const t=r.recordings.map(o=>{if(o.id!==n||e<0||e>=o.entries.length)return o;const c=o.entries.filter((d,a)=>a!==e);return{...o,entries:c}});return{...r,recordings:t}}function z(r,n,e){const t=r.recordings.map(o=>{if(o.id!==n)return o;const c=o.ignorePatterns||[];return c.includes(e)?o:{...o,ignorePatterns:[...c,e]}});return{...r,recordings:t}}function J(r,n,e){const t=r.recordings.map(o=>o.id!==n||!o.ignorePatterns?o:{...o,ignorePatterns:o.ignorePatterns.filter(c=>c!==e)});return{...r,recordings:t}}function y(r,n,e,t){const o=r.recordings.map(c=>{if(c.id!==n||e<0||e>=c.entries.length)return c;const d=[...c.entries];return d[e]=t(d[e]),{...c,entries:d}});return{...r,recordings:o}}function Q(r,n,e,t){return y(r,n,e,o=>!o.bodyVariants||t<0||t>=o.bodyVariants.length?o:{...o,activeVariant:t,body:o.bodyVariants[t].body})}function X(r,n,e,t,o){return y(r,n,e,c=>{const d=c.bodyVariants?[...c.bodyVariants]:[{name:"default",body:c.body||""}];return d.push({name:t,body:o}),{...c,bodyVariants:d,activeVariant:d.length-1,body:o}})}function Z(r,n,e,t){return y(r,n,e,o=>{if(!o.bodyVariants||t<0||t>=o.bodyVariants.length)return o;if(o.bodyVariants.length<=1){const{bodyVariants:a,activeVariant:s,...P}=o;return P}const c=o.bodyVariants.filter((a,s)=>s!==t),d=Math.min(o.activeVariant||0,c.length-1);return{...o,bodyVariants:c,activeVariant:d,body:c[d].body}})}function m(r,n,e,t,o){return y(r,n,e,c=>{if(!c.bodyVariants||t<0||t>=c.bodyVariants.length)return c;const d=c.bodyVariants.map((a,s)=>s===t?{...a,name:o}:a);return{...c,bodyVariants:d}})}function rr(r,n,e){const t=r.recordings.map(o=>{if(o.id!==n||e<0||e>=o.entries.length)return o;const c=[...o.entries];return c[e]={...c[e],disabled:!c[e].disabled},{...o,entries:c}});return{...r,recordings:t}}function er(r,n,e){const t=r.recordings.map(o=>{if(o.id!==n||e<0||e>=o.entries.length)return o;const c=o.entries.every((a,s)=>s===e?!a.disabled:a.disabled),d=o.entries.map((a,s)=>({...a,disabled:c?!1:s!==e}));return{...o,entries:d}});return{...r,recordings:t}}function nr(r,n,e){const t=r.recordings.map(o=>{if(o.id!==n)return o;const c=o.entries.map(d=>({...d,disabled:e}));return{...o,entries:c}});return{...r,recordings:t}}function tr(r){return{...r,replayHitCount:r.replayHitCount+1}}function ir(r,n){if(!r.sniffing||r.targetTabId!==null&&n.tabId!==r.targetTabId)return r;const e={method:n.method,url:n.url,type:n.type,time:Date.now()};return{...r,requests:[...r.requests,e]}}function or(r,n){let e=r;if(r.sniffing&&(r.targetTabId===null||n.tabId===r.targetTabId)){const t=r.requests.map(o=>o.url===n.url&&!o.status?{...o,status:n.statusCode}:o);e={...e,requests:t}}return e}function cr(r,n){if(!r.recording||n.tabId!==r.recordTabId||v(n.url,r.ignorePatterns))return!1;const e=w[n.type]||"other";return e==="xhr"||!r.recordFilters.includes(e)?!1:e}function R(r,n){const e=[];for(const[t,o]of Object.entries(r.activeReplays)){if(o!==n)continue;const c=r.recordings.find(d=>d.id===t);c&&e.push(...c.entries.filter(d=>!d.disabled))}return e}function h(r){return Object.keys(r.activeReplays).length>0}function dr(r){return{sniffing:r.sniffing,requests:r.requests,recording:r.recording,recordTargetId:r.recordTargetId,replaying:h(r),recordings:r.recordings.map(n=>({id:n.id,name:n.name,timestamp:n.timestamp,sourceUrl:n.sourceUrl,description:n.description||"",count:n.entries.length,originGroupIds:n.originGroupIds||[]})),activeReplays:r.activeReplays,replayHitCount:r.replayHitCount,recordEntries:r.recordEntries,recordFilters:r.recordFilters,ignorePatterns:r.ignorePatterns,originGroups:r.originGroups,knownOrigins:ur(r)}}function ur(r){const n=new Set;for(const e of r.recordings)if(e.entries)for(const t of e.entries)try{n.add(new URL(t.url).origin)}catch{}return[...n].sort()}let i=G();const ar=new Promise(r=>{chrome.storage.local.get(["recordings","recordFilters","ignorePatterns","activeReplays","originGroups","recording","recordTargetId","recordTabId"],n=>{n.recordings&&(i.recordings=n.recordings),n.recordFilters&&(i.recordFilters=n.recordFilters),n.ignorePatterns&&(i.ignorePatterns=n.ignorePatterns),n.activeReplays&&(i.activeReplays=n.activeReplays),n.originGroups&&(i.originGroups=n.originGroups),n.recording&&(i.recording=n.recording),n.recordTargetId&&(i.recordTargetId=n.recordTargetId),n.recordTabId&&(i.recordTabId=n.recordTabId),l(),r()})});function u(...r){const n={};for(const e of r)n[e]=i[e];chrome.storage.local.set(n)}const I=chrome.runtime.getURL("src/popup.html");function T(r){chrome.tabs.query({},n=>{const e=n.find(t=>t.url?.startsWith(I));e?(chrome.tabs.update(e.id,{url:r,active:!0}),chrome.windows.update(e.windowId,{focused:!0})):chrome.tabs.create({url:r})})}function g(r,n,e,t){chrome.tabs.sendMessage(r,{source:"sniffer-bg",type:"setMode",mode:n,entries:e,originGroups:t||[]})}function E(r,n){const e=[],t=new Set;for(const[o,c]of Object.entries(r.activeReplays))if(c===n)for(const d of U(r,o)){const a=d.join("\0");t.has(a)||(t.add(a),e.push(d))}return e}function f(r){const n=R(i,r),e=E(i,r);n.length>0?g(r,"replay",n,e):g(r,null,[],[])}chrome.runtime.onMessage.addListener((r,n,e)=>(ar.then(()=>lr(r,n,e)),!0));function lr(r,n,e){if(r.type==="toggle")return i=V(i),i.sniffing&&p().then(t=>{i.targetTabId=t?.id??null}),u("sniffing","requests"),e({sniffing:i.sniffing}),l(),!0;if(r.type==="getState")return e(dr(i)),!0;if(r.type==="setFilters")return i=q(i,r.filters),u("recordFilters"),e({recordFilters:i.recordFilters}),!0;if(r.type==="addIgnore")return i=C(i,r.pattern),u("ignorePatterns"),e({ignorePatterns:i.ignorePatterns}),!0;if(r.type==="removeIgnore")return i=F(i,r.pattern),u("ignorePatterns"),e({ignorePatterns:i.ignorePatterns}),!0;if(r.type==="setOriginGroups"){i=O(i,r.groups),u("originGroups");for(const t of new Set(Object.values(i.activeReplays)))f(t);return e({originGroups:i.originGroups}),!0}if(r.type==="setRecordingOriginGroups"){i=A(i,r.recordingId,r.groupIds),u("recordings");const t=i.activeReplays[r.recordingId];return t&&f(t),e({}),!0}if(r.type==="clear")return i=S(i),u("requests"),e({requests:i.requests}),!0;if(r.type==="startRecord")return i=D(i,r.filters,r.targetId),u("recordFilters","recording","recordTargetId"),p().then(t=>{i.recordTabId=t?.id??null,i.recordSourceUrl=t?.url??null,u("recordTabId"),i.recordTabId&&g(i.recordTabId,"record",[])}),e({recording:!0}),l(),!0;if(r.type==="createAndRecord"){i=k(i,r.filters);const t=i.recordTargetId;return u("recordings","recordFilters","recording","recordTargetId"),p().then(o=>{i.recordTabId=o?.id??null,i.recordSourceUrl=o?.url??null,i.recordings=i.recordings.map(c=>c.id===t?{...c,sourceUrl:i.recordSourceUrl}:c),u("recordings","recordTabId"),i.recordTabId&&g(i.recordTabId,"record",[])}),e({recording:!0,recordingId:t}),l(),!0}if(r.type==="stopRecord"){const t=i.recordTabId;return i=M(i),u("recordings","recording","recordTargetId","recordTabId"),t&&g(t,null,[]),e({recording:!1}),l(),!0}if(r.type==="stopRecordInto"){const t=i.recordTabId;return i=_(i,r.recordingId),u("recordings","recording","recordTargetId","recordTabId"),t&&g(t,null,[]),e({recording:!1}),l(),!0}if(r.source==="sniffer-intercept"&&r.type==="replayed")return i=tr(i),l(),!1;if(r.source==="sniffer-intercept"&&r.type==="captured")return i=j(i,r.entry),l(),!1;if(r.type==="startReplay"){if(!i.recordings.find(o=>o.id===r.recordingId))return e({error:"not found"}),!0;p().then(o=>{const c=o?.id??null;c&&(i.activeReplays={...i.activeReplays,[r.recordingId]:c},u("activeReplays"),f(c)),l()}),e({});return}if(r.type==="stopReplay"){const t=i.activeReplays[r.recordingId];i=H(i,r.recordingId),u("activeReplays"),t&&f(t),e({}),l();return}if(r.type==="deleteRecording"){const t=i.activeReplays[r.recordingId];i=W(i,r.recordingId),t&&f(t),u("recordings","activeReplays"),e({}),l();return}if(r.type==="copyEntries")return i=B(i,r.targetId,r.entries),u("recordings"),e({}),!0;if(r.type==="mergeRecording")return i=L(i,r.sourceId,r.targetId),u("recordings"),e({}),!0;if(r.type==="renameRecording")return i=$(i,r.recordingId,r.name),u("recordings"),e({}),!0;if(r.type==="updateRecording")return i=x(i,r.recordingId,r.updates),u("recordings"),e({}),!0;if(r.type==="getRecording"){const t=i.recordings.find(o=>o.id===r.recordingId);return e(t||null),!0}if(r.type==="updateEntry"){i=K(i,r.recordingId,r.index,r.updates),u("recordings");const t=i.activeReplays[r.recordingId];return t&&f(t),e({}),!0}if(r.type==="dedupeEntries")return i=N(i,r.recordingId),u("recordings"),e({}),!0;if(r.type==="deleteEntry")return i=Y(i,r.recordingId,r.index),u("recordings"),e({}),!0;if(r.type==="toggleEntry"){i=rr(i,r.recordingId,r.index),u("recordings");const t=i.activeReplays[r.recordingId];return t&&f(t),e({}),!0}if(r.type==="soloEntry"){i=er(i,r.recordingId,r.index),u("recordings");const t=i.activeReplays[r.recordingId];return t&&f(t),e({}),!0}if(r.type==="toggleAllEntries"){i=nr(i,r.recordingId,r.disabled),u("recordings");const t=i.activeReplays[r.recordingId];return t&&f(t),e({}),!0}if(r.type==="addRecordingIgnore")return i=z(i,r.recordingId,r.pattern),u("recordings"),e({}),!0;if(r.type==="removeRecordingIgnore")return i=J(i,r.recordingId,r.pattern),u("recordings"),e({}),!0;if(r.type==="setActiveVariant"){i=Q(i,r.recordingId,r.index,r.variantIndex),u("recordings");const t=i.activeReplays[r.recordingId];return t&&f(t),e({}),!0}if(r.type==="addVariant")return i=X(i,r.recordingId,r.index,r.name,r.body),u("recordings"),e({}),!0;if(r.type==="deleteVariant"){i=Z(i,r.recordingId,r.index,r.variantIndex),u("recordings");const t=i.activeReplays[r.recordingId];return t&&f(t),e({}),!0}if(r.type==="renameVariant")return i=m(i,r.recordingId,r.index,r.variantIndex,r.name),u("recordings"),e({}),!0;if(r.type==="openRecording")return T(I+"?recording="+r.recordingId),e({}),!0;if(r.type==="openDashboard")return r.tabId&&(b=r.tabId),T(I),e({}),!0;if(r.type==="setCorner"){chrome.storage.local.set({snifferCorner:r.corner});const t=n.tab?.id;return t&&chrome.tabs.sendMessage(t,{source:"sniffer-bg",type:"setCorner",corner:r.corner}),e({}),!0}if(r.source==="sniffer-bridge"&&r.type==="init"){const t=n.tab?.id;return chrome.storage.local.get("snifferCorner",o=>{const c=o.snifferCorner||"br",d=R(i,t);if(d.length>0){const a=E(i,t);e({mode:"replay",entries:d,originGroups:a,corner:c})}else i.recording&&t===i.recordTabId?e({mode:"record",entries:[],originGroups:[],corner:c}):e({mode:null,originGroups:[],corner:c})}),!0}}chrome.webRequest.onBeforeRequest.addListener(r=>{i=ir(i,r),i.sniffing&&u("requests")},{urls:["<all_urls>"]});chrome.webRequest.onCompleted.addListener(r=>{i=or(i,r),i.sniffing&&u("requests");const n=cr(i,r);n&&fr(r,n)},{urls:["<all_urls>"]});async function fr(r,n){const e={url:r.url,method:r.method,status:r.statusCode,statusText:"",kind:n,time:Date.now(),body:"",headers:{}};try{const t=await fetch(r.url);e.body=await t.text(),e.headers=Object.fromEntries(t.headers.entries())}catch{}i.recordEntries.push(e),l()}function l(){let r="";i.recording?r=`${i.recordEntries.length}`:h(i)?r=`${i.replayHitCount}`:i.sniffing&&(r="ON");let n="#999";i.recording?n="#e74c3c":h(i)?n="#2ecc71":i.sniffing&&(n="#e74c3c"),chrome.action.setBadgeText({text:r}),chrome.action.setBadgeBackgroundColor({color:n})}let b=null;function p(){return new Promise(r=>{b?chrome.tabs.get(b,n=>{chrome.runtime.lastError||!n?r(null):r(n)}):chrome.tabs.query({currentWindow:!0},n=>{const e=n.find(t=>t.active&&!t.url?.startsWith("chrome"))||n.find(t=>!t.url?.startsWith("chrome"));r(e||null)})})}
