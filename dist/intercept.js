function W(i){try{const d=new URL(i);if(d.pathname.split("/").some(o=>o.startsWith(":")))return!0;for(const o of d.searchParams.values())if(o.startsWith(":"))return!0;return!1}catch{return!1}}function j(i,d,o){if(!o||o.length===0)return null;try{const c=new URL(i),f=new URL(d);if(c.origin===f.origin)return null;for(const t of o)if(t.includes(c.origin)&&t.includes(f.origin))return f.origin+c.pathname+c.search+c.hash}catch{}return null}function z(i,d,o){try{const c=new URL(i),f=new URL(d);if(c.origin!==f.origin){if(!o||o.length===0)return null;let n=!1;for(const g of o)if(g.includes(c.origin)&&g.includes(f.origin)){n=!0;break}if(!n)return null}const t=c.pathname.split("/"),x=f.pathname.split("/");if(t.length!==x.length)return null;const w={};for(let n=0;n<t.length;n++)if(t[n].startsWith(":"))w[t[n]]=x[n];else if(t[n]!==x[n])return null;for(const[n,g]of c.searchParams){if(!f.searchParams.has(n))return null;if(g.startsWith(":"))w[g]=f.searchParams.get(n);else if(f.searchParams.get(n)!==g)return null}return w}catch{return null}}function C(i,d){if(!i||!d)return i;let o=i;for(const[c,f]of Object.entries(d)){const t=c.startsWith(":")?c.slice(1):c;o=o.replaceAll(`{{${t}}}`,f)}return o}function N(i,d,o,c){const f=o.find(t=>t.url===i&&t.method===d);if(f)return{entry:f,params:null};if(c&&c.length>0)for(const t of o){if(t.method!==d)continue;const x=j(i,t.url,c);if(x&&x===t.url)return{entry:t,params:null}}try{const t=new URL(i),x=t.pathname,w=t.searchParams,n=o.filter(g=>{try{const m=new URL(g.url);if(m.pathname===x&&g.method===d){if(m.origin===t.origin)return!0;if(c){for(const s of c)if(s.includes(t.origin)&&s.includes(m.origin))return!0}}return!1}catch{return!1}});if(n.length===1)return{entry:n[0],params:null};if(n.length>1){let g=null,m=-1;for(const s of n){const p=new URL(s.url).searchParams;let y=0;for(const[L,R]of p)w.get(L)===R&&y++;y>m&&(m=y,g=s)}return{entry:g,params:null}}}catch{}for(const t of o){if(t.method!==d||!W(t.url))continue;const x=z(t.url,i,c);if(x)return{entry:t,params:x}}return null}(function(){let i=null,d=[],o=[];const c=window.fetch,f=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.send,x=/^(image|video|audio|font)\//;function w(e){window.postMessage({source:"sniffer-intercept",...e},"*")}function n(e){return new Promise(r=>{const v=Math.random().toString(36).slice(2),h=u=>{u.data?.source==="sniffer-bg"&&u.data.type==="_response"&&u.data._reqId===v&&(window.removeEventListener("message",h),r(u.data.data))};window.addEventListener("message",h),w({...e,_reqId:v})})}function g(e,r){return N(e,r,d,o)}window.fetch=async function(...e){const r=new Request(...e),v=r.url,h=r.method;if(i==="replay"){const a=g(v,h);if(a){w({type:"replayed"}),a.entry.delay>0&&await new Promise(E=>setTimeout(E,a.entry.delay));const l=C(a.entry.body,a.params);return new Response(l,{status:a.entry.status,statusText:a.entry.statusText||"",headers:a.entry.headers||{}})}}const u=await c.apply(this,e);if(i==="record"){const a=u.headers.get("content-type")||"";if(!x.test(a)){const l=u.clone();try{const E=await l.text();let b=null;try{b=await r.clone().text()}catch{}w({type:"captured",entry:{url:v,method:h,status:u.status,statusText:u.statusText,headers:Object.fromEntries(u.headers.entries()),body:E,payload:b||void 0,kind:"fetch",time:Date.now()}})}catch{}}}return u},XMLHttpRequest.prototype.open=function(e,r,...v){return this._sniffer={method:e,url:new URL(r,location.href).href},f.call(this,e,r,...v)},XMLHttpRequest.prototype.send=function(e){if(!this._sniffer)return t.call(this,e);const{url:r,method:v}=this._sniffer;if(i==="replay"){const h=g(r,v);if(h){w({type:"replayed"});const u=C(h.entry.body,h.params);Object.defineProperty(this,"readyState",{value:4}),Object.defineProperty(this,"status",{value:h.entry.status}),Object.defineProperty(this,"statusText",{value:h.entry.statusText||""}),Object.defineProperty(this,"responseText",{value:u}),Object.defineProperty(this,"response",{value:u});const a=this;setTimeout(()=>{a.dispatchEvent(new Event("readystatechange")),a.dispatchEvent(new ProgressEvent("load")),a.dispatchEvent(new ProgressEvent("loadend")),a.onreadystatechange&&a.onreadystatechange(new Event("readystatechange")),a.onload&&a.onload(new ProgressEvent("load")),a.onloadend&&a.onloadend(new ProgressEvent("loadend"))},h.entry.delay||0);return}}if(i==="record"){const h=e||void 0;this.addEventListener("load",()=>{const u=this.getResponseHeader("content-type")||"";if(!x.test(u))try{w({type:"captured",entry:{url:r,method:v,status:this.status,statusText:this.statusText,body:this.responseText,payload:h,kind:"xhr",time:Date.now()}})}catch{}})}return t.call(this,e)};let m=!1,s=null,p=null,y=null;const L={br:{bottom:"12px",right:"12px",badgeAlign:"margin-left:auto;"},bl:{bottom:"12px",left:"12px",badgeAlign:"margin-right:auto;"},tr:{top:"12px",right:"12px",badgeAlign:"margin-left:auto;"},tl:{top:"12px",left:"12px",badgeAlign:"margin-right:auto;"}};let R="br";try{R=localStorage.getItem("__sniffer_corner__")||"br"}catch{}function k(e){const r=document.createElement("div");return r.textContent=e,r.innerHTML}function S(){if(!y)return;const e=L[R]||L.br,r=R.startsWith("b");y.style.cssText=`position:fixed;z-index:2147483647;font:11px/1.4 monospace;color:#fff;display:flex;flex-direction:${r?"column-reverse":"column"};`,y.style.top=e.top||"auto",y.style.bottom=e.bottom||"auto",y.style.left=e.left||"auto",y.style.right=e.right||"auto",s&&(s.style.marginLeft=R.endsWith("r")?"auto":"",s.style.marginRight=R.endsWith("l")?"auto":"")}function O(e){R=e;try{localStorage.setItem("__sniffer_corner__",e)}catch{}S(),p&&(p.remove(),p=null),m&&_()}function I(){y||(y=document.createElement("div"),y.id="__sniffer_ui__",S(),document.documentElement.appendChild(y))}function $(){I(),s||(s=document.createElement("button"),s.style.cssText="padding:5px 10px;border-radius:6px;cursor:pointer;user-select:none;border:none;font:bold 11px/1 monospace;color:#fff;opacity:0.9;display:block;"+(L[R]||L.br).badgeAlign,s.addEventListener("mouseenter",()=>{s.style.opacity="1"}),s.addEventListener("mouseleave",()=>{s.style.opacity="0.9"}),s.addEventListener("click",q),y.appendChild(s)),i==="record"?(s.style.background="#e74c3c",s.textContent="● REC"):i==="replay"?(s.style.background="#2ecc71",s.textContent="▶ REPLAY"):(s.style.background="#555",s.textContent="● SNIFFER")}function q(){m=!m,m?_():p&&(p.remove(),p=null)}async function _(){if(!m)return;const e=await n({type:"getState"});if(!e||!m)return;I(),p||(p=document.createElement("div"),p.style.cssText="background:#1a1a2e;border:1px solid #444;border-radius:8px;width:280px;max-height:320px;overflow-y:auto;margin:6px 0;box-shadow:0 4px 20px rgba(0,0,0,0.5);",y.appendChild(p));const r=e.recordings||[],v=e.activeReplays||{},h=e.recording,u=e.recordTargetId;let a=`<div style="padding:8px 10px;border-bottom:1px solid #333;font-size:10px;color:#888;text-transform:uppercase;display:flex;align-items:center;justify-content:space-between;"><span>Recordings (${r.length})</span><span style="cursor:pointer;font-size:14px;line-height:1;color:#666;" data-action="close">&times;</span></div>`;if(r.length===0)a+='<div style="padding:16px 10px;text-align:center;font-size:11px;color:#666;">No recordings</div>';else for(const l of r){const E=l.id in v,b=h&&u===l.id,P=E?"padding:3px 8px;border:1px solid #2ecc71;border-radius:4px;background:#2ecc71;color:#fff;cursor:pointer;font:10px monospace;flex-shrink:0;":"padding:3px 8px;border:1px solid #444;border-radius:4px;background:#2a2a3e;color:#888;cursor:pointer;font:10px monospace;flex-shrink:0;",T=E?"Stop":"Replay",A=E?"stopReplay":"startReplay",M=b?"padding:3px 8px;border:1px solid #e74c3c;border-radius:4px;background:#e74c3c;color:#fff;cursor:pointer;font:10px monospace;flex-shrink:0;":"padding:3px 8px;border:1px solid #444;border-radius:4px;background:#2a2a3e;color:#888;cursor:pointer;font:10px monospace;flex-shrink:0;",U=b?"Stop":"Rec",H=b?"stopRecord":"startRecord";a+=`<div style="display:flex;align-items:center;gap:6px;padding:6px 10px;border-bottom:1px solid #222;"><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px;color:#e0e0e0;cursor:pointer;" title="${k(l.name)}" data-action="openRecording" data-id="${l.id}">${k(l.name)}</span><span style="font-size:10px;color:#666;white-space:nowrap;">${l.count}</span><button style="${M}" data-action="${H}" data-id="${l.id}">${U}</button><button style="${P}" data-action="${A}" data-id="${l.id}">${T}</button></div>`}p.innerHTML=a,p.querySelectorAll("[data-action='openRecording']").forEach(l=>{l.addEventListener("mouseenter",()=>{l.style.textDecoration="underline"}),l.addEventListener("mouseleave",()=>{l.style.textDecoration="none"})}),p.querySelectorAll("[data-action]").forEach(l=>{l.addEventListener("click",async E=>{E.stopPropagation();const b=l.dataset.action,P=l.dataset.id;if(b==="close"){m=!1,p&&(p.remove(),p=null);return}if(b==="openRecording"){w({type:"openRecording",recordingId:P});return}if(b==="startRecord"){const T=await n({type:"getState"});await n({type:"startRecord",filters:T?.recordFilters||["xhr","fetch"],targetId:P})}else b==="stopRecord"?await n({type:"stopRecordInto",recordingId:P}):b==="startReplay"?await n({type:"startReplay",recordingId:P}):b==="stopReplay"&&await n({type:"stopReplay",recordingId:P});_()})})}try{const e=localStorage.getItem("__sniffer__");if(e){const r=JSON.parse(e);i=r.mode,d=r.entries||[],o=r.originGroups||[]}}catch{}$(),window.addEventListener("message",e=>{e.data?.source==="sniffer-bg"&&(e.data.type==="setMode"&&(i=e.data.mode,d=e.data.entries||[],o=e.data.originGroups||[],$(),m&&_()),e.data.type==="setCorner"&&O(e.data.corner))})})();
